name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Version tag to rollback to (e.g., v0.2.1)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  validate-rollback:
    name: Validate Rollback Target
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify tag exists
        run: |
          git fetch --all --tags
          if ! git tag -l | grep -q "^${{ github.event.inputs.target_version }}$"; then
            echo "‚ùå Tag ${{ github.event.inputs.target_version }} does not exist"
            git tag -l
            exit 1
          fi
          echo "‚úÖ Tag ${{ github.event.inputs.target_version }} verified"

      - name: Log rollback initiation
        run: |
          echo "üö® ROLLBACK INITIATED"
          echo "Target Version: ${{ github.event.inputs.target_version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  rollback-edge-functions:
    name: Rollback Edge Functions
    runs-on: ubuntu-latest
    needs: [validate-rollback]
    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_version }}

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Rollback Edge Functions
        run: |
          echo "‚è™ Rolling back Edge Functions to ${{ github.event.inputs.target_version }}..."

          if [ -d "supabase/functions/chat" ]; then
            supabase functions deploy chat --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          fi

          if [ -d "supabase/functions/faq-helper" ]; then
            supabase functions deploy faq-helper --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          fi

          if [ -d "supabase/functions/rate-limiter" ]; then
            supabase functions deploy rate-limiter --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          fi

          echo "‚úÖ Edge Functions rolled back"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  rollback-frontend:
    name: Rollback Frontend
    runs-on: ubuntu-latest
    needs: [rollback-edge-functions]
    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build target version
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Deploy rolled back version
        run: |
          echo "‚è™ Deploying ${{ github.event.inputs.target_version }}..."
          # Add Lovable deployment command when available
          echo "‚úÖ Frontend rollback completed"

  verify-rollback:
    name: Verify Rollback Success
    runs-on: ubuntu-latest
    needs: [rollback-frontend]
    steps:
      - name: Health Check
        run: |
          echo "üß™ Verifying rollback..."
          sleep 10

          # Test production endpoints
          SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          if [ -n "$SUPABASE_URL" ]; then
            echo "Testing production health..."
            # Add health check tests
            echo "‚úÖ Rollback verified"
          fi

      - name: Create rollback incident report
        run: |
          echo "üìù Rollback Incident Report"
          echo "=========================="
          echo "Previous Version: (current production before rollback)"
          echo "Rolled Back To: ${{ github.event.inputs.target_version }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Executed By: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Status: Success"

  notify-rollback:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [verify-rollback]
    if: always()
    steps:
      - name: Notification
        run: |
          STATUS="${{ needs.verify-rollback.result }}"
          if [ "$STATUS" == "success" ]; then
            MESSAGE="‚úÖ ROLLBACK SUCCESSFUL to ${{ github.event.inputs.target_version }}"
          else
            MESSAGE="‚ùå ROLLBACK FAILED - Manual intervention required"
          fi

          echo "$MESSAGE"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Executed by: ${{ github.actor }}"

          # Add Slack/Discord webhook notification here if configured
          # curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          #   -H 'Content-Type: application/json' \
          #   -d "{\"text\":\"üö® $MESSAGE\"}"
